<!DOCTYPE html>
<html style="font-size: 500px; -uc-font-scale: disable;">
<head>
    <meta charset="utf-8">
    <script type="text/javascript" crossorigin="anonymous" async="" src="https://g.alicdn.com/woodpeckerx/itrace-next/??itrace-flow.iife.js,itrace-perf.iife.js,itrace-resource.iife.js,itrace-blank.iife.js"></script>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="data-fact" content="clouddrive">
    <meta name="spm-id" content="clouddrive">
    <meta name="data-spm" content="clouddrive">
    <meta name="aplus-waiting" content="MAN">
    <meta name="multiple-page">
    <meta name="wpk-bid" content="af735vea-hmo5i8tm">
    <meta name="wpk-rel" content="1.8.3">
    <link href="data:image/x-icon;data:image/vnd.microsoft.icon;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAACrUExURUdwTBEWGREVGRIWGREWGREVGQAkJBUVFREVGhEWGhEVGREVGQAqKhIWGRAWGxEWHBIWGv///xMXG/7+/o+Qkh8jJigsMGFkZoiKjD5BRJ+ho3p8f1ZZXG5wc0VISxUZHfn5+eTl5cfIyfX19XR3eausrr6/wFBTVpyeoC0xNCQnKzc6PlteYdvb3LO0tWhrbn1/gYWHiYCChMTFxuzs7NLT1NfY2Ofn6BgbH+UPa/sAAAAQdFJOUwDZv5XjxwcY9PJHggaWLi1e/SYZAAABc0lEQVR42oWT63KCMBCFI2gVkPYkKSoV79b7pWptff8nK5tNFMbO8P1hyEmyZy8RD9qh79WCoOb5YVs804wD3AnipijzErVQohW9lI438ESjcMlrHf9Qf7ufN3rSPQ+GqrSjaePT/Wo+kzk/WSkK+4hIP0hGH1EgMgHI/1w6dErKzuZCQWKKP3tsOADozayZOK8f1acrH6xyXeqRrVhbhPQd7PdO/1C5LvVnB4ZQ+DCcijoxWYPwhQdiqAs6swDhiRqIy11PF9+SMenUhOlhR7M/4/3WnUhiYFzyhq47r7bZGthM6bdvNnCIL1q4jJDR2WuKDX2XHMKDLaTeunKMU9ySJFHGJKe5zJenSJy9K5AslU0zdCbfkUnHGlO2gJBLjQN5OktHhoM+cqm5WUi1XBU6MoTiUseu3ejLCzpjq/+OUGi3iLgZ4y1lyyw2MERu5IhhD6rv7ljZkSsOLRSlszv1iAEPbeXYVz+c6qdX/Xgrn/8fOew7Unyn5yIAAAAASUVORK5CYII=" rel="icon" type="image/x-icon">
    <title>测试</title>
    <link rel="stylesheet" href="https://g.alicdn.com/code/npm/@ali/uc-pegasus-source-project-uc-clouddrive-shareh5/1.8.3/css/pages/index/index.99a531.css">
    <link rel="stylesheet" href="https://g.alicdn.com/code/npm/@ali/uc-pegasus-source-project-uc-clouddrive-shareh5/1.8.3/css/pages/index/index_bootstrap.99a531.css">
    <link rel="stylesheet" type="text/css" href="https://g.alicdn.com/code/npm/@ali/uc-pegasus-source-project-uc-clouddrive-shareh5/1.8.3/css/asyncPicker.99a531.css">
    <style>
        .btn-custom {
            margin: 10px 0;
            padding: 10px 20px;
            border: none;
            color: #fff;
            cursor: pointer;
            width: 100%;
        }
        .btn-copy-url {
            background-color: #007bff;
        }
        .btn-copy-gitee {
            background-color: #17a2b8;
        }
        .btn-download {
            background-color: #28a745;
        }
        .btn-faq {
            background-color: #ffffff;
            color: #000000;
        }
        .foot-button-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #fff;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .content-body-h5 {
            padding-bottom: 80px;
        }
        .progress-container {
            padding: 0 20px;
        }
        #progressBar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
        }
        #progress {
            width: 0%;
            height: 100%;
            background-color: #4CAF50;
            border-radius: 10px;
            transition: width 0.3s;
        }
        #progressText {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }
    </style>
</head>
<body style="font-size:16px" inmaintabuse="1">
    <div id="root">
        <div class="share-detail-content-h5-wrap">
            <div class="share-detail-content-h5">
                <div class="share-detail-scroll">
                    <div></div>
                    <div class="share-info-wrap">
                        <div class="share-info_l">
                            <div class="avatar-wrap">
                                <img class="avatar" src="//image.quark.cn/s/uae/g/3o/broccoli/resource/202309/73a5c130-4b00-11ee-8cd0-efec1d59dc4e.png">
                            </div>
                            <div class="info-wrap">
                                <span class="author-name">测试：北的屋.com</span>
                                <span class="file-stat">永久有效</span>
                            </div>
                        </div>
                    </div>
                    <div class="content-body-h5">
                        <div class="mini-file-list">
                            <div class="file-item">
                                <div class="file-item__hd">
                                    <div class="file-icon h5-share-file-icon">
                                        <div style="width: 100%; height: 100%; background-size: cover; background-position: 50% 50%; background-repeat: no-repeat; background-image: url('https://img.alicdn.com/imgextra/i2/O1CN01ywiSkM1fgzicipvFF_!!6000000004037-2-tps-192-192.png');">
                                        </div>
                                    </div>
                                </div>
                                <div class="file-item__bd">
                                    <div class="file-item-info">
                                        <div class="item-tit" title="blob下载测试70m.dmg.zip">blob下载测试70m.dmg.zip</div>
                                        <div class="item-sub-tit">
                                            <span>2025-01-21</span>
                                            <span>84.81 MB</span>
                                        </div>
                                    </div>
                                </div>
                                <input type="checkbox" class="h5-content-check h5-content-check-off">
                            </div>
                        </div>
                        
                        <!-- 合并进度显示区域 -->
                        <div class="progress-container">
                            <div id="progressBar">
                                <div id="progress"></div>
                            </div>
                            <div id="progressText">0%</div>
                        </div>
                    </div>
                </div>
                
                <!-- 底部按钮 -->
                <div class="foot-button-wrap">
                    <button type="button" class="btn-custom btn-copy-url" onclick="copyCurrentURL()">复制地址1</button>
                    <button type="button" class="btn-custom btn-copy-gitee" onclick="copyGiteeURL()">复制地址2</button>
                    <button type="button" class="btn-custom btn-download" onclick="startMerge()">开始合并</button>
                    <a href="https://xn--djr07sn3v.com" target="_blank">
                        <button class="btn-custom btn-faq" role="button">进群获取更多资源</button>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
                // 在其他脚本之前添加域名检测和URL替换逻辑
        (function checkAndReplaceDomain() {
            const targetDomain = 'pan2-3f0.pages.dev';
            const currentDomain = window.location.hostname;
            const oldDomain = 'xiaobeirepo.github.io/pan2/';
            
            if (currentDomain === targetDomain) {
                // 如果filelist数组已经存在，替换其中的URL
                if (typeof filelist !== 'undefined' && Array.isArray(filelist)) {
                    filelist = filelist.map(url => {
                        const oldUrl = new URL(url);
                        if (oldUrl.href.includes(oldDomain)) {
                            return `https://${targetDomain}/${oldUrl.pathname.split('/').pop()}`;
                        }
                        return url;
                    });
                }
            }
        })();

        async function copyCurrentURL() {
            const url = window.location.href;

            try {
                await navigator.clipboard.writeText(url);
                alert('地址1已复制，粘贴进xbb下载器即可');
            } catch (err) {
                console.error('复制失败，请更换浏览器，错误代码:', err);
                fallbackCopyTextToClipboard(url);
            }
        }

        async function copyGiteeURL() {
            const giteeUrl = "giteemd";

            try {
                await navigator.clipboard.writeText(giteeUrl);
                alert('地址2已复制，粘贴进xbb下载器即可');
            } catch (err) {
                console.error('复制失败，请更换浏览器，错误代码：', err);
                fallbackCopyTextToClipboard(giteeUrl);
            }
        }

        function fallbackCopyTextToClipboard(text) {
            const tempInput = document.createElement('input');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            alert('地址已复制，粘贴进xbb下载器即可');
        }

        var filelist = ['https://xiaobeirepo.github.io/pan2/AHuF5DBVblob下载测试70m.dmg_part0001.zip', 'https://xiaobeirepo.github.io/pan2/AHuF5DBVblob下载测试70m.dmg_part0002.zip', 'https://xiaobeirepo.github.io/pan2/AHuF5DBVblob下载测试70m.dmg_part0003.zip', 'https://xiaobeirepo.github.io/pan2/AHuF5DBVblob下载测试70m.dmg_part0004.zip', 'https://xiaobeirepo.github.io/pan2/AHuF5DBVblob下载测试70m.dmg_part0005.zip', 'https://xiaobeirepo.github.io/pan2/AHuF5DBVblob下载测试70m.dmg_part0006.zip', 'https://xiaobeirepo.github.io/pan2/AHuF5DBVblob下载测试70m.dmg_part0007.zip', 'https://xiaobeirepo.github.io/pan2/AHuF5DBVblob下载测试70m.dmg_part0008.zip', 'https://xiaobeirepo.github.io/pan2/AHuF5DBVblob下载测试70m.dmg_part0009.zip', ]; //文件切片数组

        async function startMerge() {
            if (filelist.length === 0) {
                alert('没有检测到文件切片！');
                return;
            }

            const fileName = document.querySelector('.item-tit').textContent || 'merged_file';
            const totalChunks = filelist.length;
            const chunks = new Array(totalChunks);
            let downloadedSize = 0;
            let lastTime = Date.now();
            let lastDownloadedSize = 0;
            let downloading = false;

            // 进度更新函数
            function updateProgress() {
                if (!downloading) return;  // 如果还没开始下载，不更新进度

                const currentTime = Date.now();
                const timeDiff = (currentTime - lastTime) / 1000;
                const sizeDiff = downloadedSize - lastDownloadedSize;
                const speedBps = sizeDiff / timeDiff;

                const progress = Math.round((chunks.filter(Boolean).length / totalChunks) * 100) || 0;
                document.getElementById('progress').style.width = progress + '%';

                const formatSize = (bytes) => {
                    if (bytes >= 1048576) {
                        return (bytes / 1048576).toFixed(2) + 'M';
                    }
                    return (bytes / 1024).toFixed(2) + 'KB';
                };

                const formatSpeed = (bytesPerSecond) => {
                    if (bytesPerSecond >= 1048576) {
                        return (bytesPerSecond / 1048576).toFixed(2) + 'M/s';
                    }
                    return (bytesPerSecond / 1024).toFixed(2) + 'KB/s';
                };

                document.getElementById('progressText').textContent = 
                    `已下载：${formatSize(downloadedSize)} ${progress}% 下载速度：${formatSpeed(speedBps)}`;

                lastTime = currentTime;
                lastDownloadedSize = downloadedSize;
            }

            // 使用 ReadableStream 来跟踪下载进度
            async function downloadChunk(index) {
                try {
                    const response = await fetch(filelist[index]);
                    const reader = response.body.getReader();
                    const contentLength = +response.headers.get('Content-Length');
                    let receivedLength = 0;
                    const chunks = [];

                    while(true) {
                        const {done, value} = await reader.read();
                        if (done) break;
                        
                        chunks.push(value);
                        receivedLength += value.length;
                        downloadedSize += value.length;
                    }

                    const blob = new Blob(chunks);
                    return blob;
                } catch (error) {
                    throw new Error(`下载切片 ${index} 失败: ${error.message}`);
                }
            }

            try {
                downloading = true;  // 标记开始下载
                document.getElementById('progressText').textContent = '准备开始下载...';
                
                // 定时更新进度和速度
                const progressInterval = setInterval(updateProgress, 1000);

                // 并发下载切片
                const CONCURRENT_DOWNLOADS = 6;
                
                // 分批次下载
                for (let i = 0; i < totalChunks; i += CONCURRENT_DOWNLOADS) {
                    const downloadPromises = [];
                    for (let j = 0; j < CONCURRENT_DOWNLOADS && (i + j) < totalChunks; j++) {
                        downloadPromises.push(
                            downloadChunk(i + j).then(blob => {
                                chunks[i + j] = blob;
                            })
                        );
                    }
                    await Promise.all(downloadPromises);
                }

                downloading = false;  // 标记下载完成
                clearInterval(progressInterval);
                updateProgress();

                // 合并所有切片
                const mergedBlob = new Blob(chunks, {type: 'application/octet-stream'});

                // 创建下载链接
                const downloadUrl = URL.createObjectURL(mergedBlob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(downloadUrl);

            } catch (error) {
                downloading = false;
                clearInterval(progressInterval);
                console.error('合并出错:', error);
                alert('合并过程中出现错误，请重试');
            }
        }
    </script>
</body>
</html>
